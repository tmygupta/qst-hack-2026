{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "583e0116-dc60-4df1-8814-6537fc3b5b80",
   "metadata": {},
   "outputs": [],
   "source": [
    "import ipywidgets as widgets\n",
    "from IPython.display import display\n",
    "\n",
    "import numpy as np\n",
    "from mrmustard.lab.states import Coherent, Number, SqueezedVacuum, Vacuum\n",
    "from mrmustard.lab.transformations import BSgate, Sgate, Dgate"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "2488583e-f331-45ca-959d-f9b6322a05ba",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "f9f91a4ce53447e99e4783e996c2e0b1",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HBox(children=(VBox(children=(HTML(value='\\n<style>\\ntd {\\n  border: 1px solid;\\n}\\nth {\\n  border: 1px solid;…"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "#Cirquit for set parameters (n1,n2, (r_i,phi_i), (theta_j, phi_BS_j), N)\n",
    "\n",
    "#Squeezed state parameters\n",
    "r0, r1, r2 = 1, 1, 1\n",
    "phi_0, phi_1, phi_2 = 0, np.pi/2, np.pi\n",
    "\n",
    "#Initialize squeezed state\n",
    "initial_state = Vacuum([0,1,2]) >> Sgate(0, r0, phi_0) >> Sgate(1, r1, phi_1) >> Sgate(2, r2, phi_2)\n",
    "\n",
    "#Beamsplitter parameters (transmitivity- and phase-angles)\n",
    "theta_1, phi_BS_1 = np.pi/4, 0\n",
    "theta_2, phi_BS_2 = np.pi/4, 0\n",
    "theta_3, phi_BS_3 = np.pi/4, 0\n",
    "\n",
    "#Number of photons\n",
    "n1, n2 = 1, 1\n",
    "N = 4 #cutoff\n",
    "\n",
    "#Set cirquit evolution\n",
    "unitary = BSgate([0,1], theta_1,phi_BS_1) >> BSgate([1,2], theta_2,phi_2) >> BSgate([0,1], theta_3,phi_BS_3)\n",
    "final_state = initial_state >> unitary \n",
    "\n",
    "\n",
    "# Memory-efficient post-selection using Number.dual\n",
    "proj = Number(0, n1,N).dual >> Number(1, n2,N).dual\n",
    "\n",
    "# Apply projectors to the final state\n",
    "final_state_postselected = final_state >> proj\n",
    "\n",
    "# Inspect\n",
    "final_state_postselected\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "b6446a99-f250-4186-be72-955612e8a4d3",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "e93bc6b45ac14d879429eed04d6f19bd",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "interactive(children=(FloatSlider(value=1.0, description='r0', max=4.0, step=0.01), FloatSlider(value=1.0, des…"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Cirquit generation with interactive parameters\n",
    "\n",
    "def update_circuit(r0, r1, r2, phi0, phi1, phi2,n1,n2):\n",
    "    # Build initial squeezed state\n",
    "    initial_state = Vacuum([0,1,2]) >> Sgate(0, r0, phi0)>> Sgate(1, r1, phi1)>> Sgate(2, r2, phi2)\n",
    "\n",
    "    # Unitary evolution\n",
    "    unitary = BSgate([0,1], theta_1, phi_BS_1) >> BSgate([1,2], theta_2, phi_BS_2) >> BSgate([0,1], theta_3, phi_BS_3)\n",
    "    final_state = initial_state >> unitary\n",
    "\n",
    "    # Memory-efficient post-selection\n",
    "    proj = Number(0, n1, N).dual >> Number(1, n2, N).dual\n",
    "    post_state = final_state >> proj\n",
    "\n",
    "    display(post_state)\n",
    "    \n",
    "\n",
    "\n",
    "# Sliders for squeezed state\n",
    "r0_slider = widgets.FloatSlider(min=0, max=4, step=0.01, value=1, description='r0')\n",
    "r1_slider = widgets.FloatSlider(min=0, max=4, step=0.01, value=1, description='r1')\n",
    "r2_slider = widgets.FloatSlider(min=0, max=4, step=0.01, value=1, description='r2')\n",
    "\n",
    "phi0_slider = widgets.FloatSlider(min=0, max=2*np.pi, step=0.01, value=0, description='phi0')\n",
    "phi1_slider = widgets.FloatSlider(min=0, max=2*np.pi, step=0.01, value=np.pi/2, description='phi1')\n",
    "phi2_slider = widgets.FloatSlider(min=0, max=2*np.pi, step=0.01, value=np.pi, description='phi2')\n",
    "\n",
    "# Sliders for post-selection photon numbers\n",
    "n1_slider = widgets.IntSlider(min=0, max=N, step=1, value=0, description='n1')\n",
    "n2_slider = widgets.IntSlider(min=0, max=N, step=1, value=0, description='n2')\n",
    "\n",
    "# Interactive plot\n",
    "interactive_plot = widgets.interactive(update_circuit,\n",
    "                                       r0=r0_slider, r1=r1_slider, r2=r2_slider,\n",
    "                                       phi0=phi0_slider, phi1=phi1_slider, phi2=phi2_slider, n1=n1_slider, n2=n2_slider)\n",
    "display(interactive_plot)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "13b8a721-c946-4a6d-87df-7cef63cd7f45",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
